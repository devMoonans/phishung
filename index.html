<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>í”¼ì‹± íƒì§€ ì‹œë®¬ë ˆì´í„° - On-Device AI</title>
  <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
  <style>
    /* =========================================
       ë””ìì¸(CSS)ì€ ì›ë³¸ê³¼ 100% ë™ì¼í•©ë‹ˆë‹¤.
       (ë°˜ì‘í˜• ê´€ë ¨ CSSë§Œ ë§¨ ì•„ë˜ì— "ì¶”ê°€"ë¨)
       ========================================= */
    body { background-color: #121212; color: white; font-family: 'Apple SD Gothic Neo', sans-serif; margin: 0; height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden; }
    #landing-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); z-index: 2000; overflow-y: auto; transition: opacity 0.5s ease; display: flex; flex-direction: column; align-items: center; }
    .hero-section { min-height: 100vh; width: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; position: relative; }
    .landing-icon { font-size: 5rem; margin-bottom: 20px; animation: float 3s ease-in-out infinite; }
    .landing-title { font-size: 3rem; font-weight: bold; margin-bottom: 10px; background: linear-gradient(to right, #4facfe 0%, #00f2fe 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .landing-subtitle { font-size: 1.2rem; color: #ccc; margin-bottom: 40px; max-width: 600px; line-height: 1.6; }
    .start-btn { padding: 15px 40px; font-size: 1.2rem; font-weight: bold; color: white; background: linear-gradient(45deg, #4facfe, #00f2fe); border: none; border-radius: 30px; cursor: pointer; box-shadow: 0 10px 20px rgba(0, 242, 254, 0.3); transition: transform 0.2s, box-shadow 0.2s; margin-bottom: 20px; }
    .start-btn:hover { transform: translateY(-3px); box-shadow: 0 15px 25px rgba(0, 242, 254, 0.5); }
    .scroll-hint { position: absolute; bottom: 30px; color: rgba(255,255,255,0.5); animation: bounce 2s infinite; font-size: 0.9rem; cursor: pointer; }
    .info-section { width: 100%; padding: 80px 20px; background: rgba(0,0,0,0.2); text-align: center; box-sizing: border-box; }
    .info-container { max-width: 1000px; margin: 0 auto; }
    .section-title { font-size: 2rem; margin-bottom: 50px; color: #fff; position: relative; display: inline-block; }
    .section-title::after { content: ''; display: block; width: 60%; height: 3px; background: #4facfe; margin: 10px auto 0; border-radius: 2px; }
    .features-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px; text-align: left; }
    .feature-card { background: rgba(255,255,255,0.05); padding: 30px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); transition: transform 0.3s ease; }
    .feature-card:hover { transform: translateY(-5px); background: rgba(255,255,255,0.1); }
    .feature-icon { font-size: 2.5rem; margin-bottom: 20px; display: block; }
    .feature-title { font-size: 1.3rem; font-weight: bold; margin-bottom: 10px; color: #81d4fa; }
    .feature-desc { font-size: 0.95rem; color: #ccc; line-height: 1.6; }
    .footer { padding: 40px; text-align: center; font-size: 0.8rem; color: #666; background: rgba(0,0,0,0.3); width: 100%; box-sizing: border-box; }

    #app-container { display: none; width: 100%; height: 100%; justify-content: center; align-items: center; animation: fadeIn 1s ease; }
    .main-layout { display: flex; width: 95%; max-width: 1400px; height: 85vh; gap: 20px; transition: transform 0.3s ease; }

    .side-panel { flex: 1; background: rgba(255, 255, 255, 0.05); border-radius: 20px; padding: 20px; display: flex; flex-direction: column; border: 1px solid rgba(255, 255, 255, 0.1); }
    h3 { margin-top: 0; color: #aaa; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #444; padding-bottom: 10px;}
    #analysis-log { flex: 1; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.85rem; display: flex; flex-direction: column; gap: 8px; }
    .log-item { padding: 8px; background: rgba(0, 0, 0, 0.3); border-left: 3px solid #4a90e2; border-radius: 4px; animation: slideIn 0.3s ease; }
    .log-warning { border-left-color: #f1c40f; background: rgba(241, 196, 15, 0.1); color: #f1c40f; }
    .log-danger { border-left-color: #e74c3c; background: rgba(231, 76, 60, 0.1); color: #ffadad; font-weight: bold; }
    .log-safe { border-color: #2ecc71; color: #abebc6; }
    .log-send { border-left-color: #999; color: #bbb; background: rgba(255,255,255,0.05); }

    #transcript-box { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
    .transcript-bubble { background: #2c3e50; padding: 12px; border-radius: 12px; font-size: 1rem; line-height: 1.4; animation: fadeIn 0.3s; position: relative; transition: all 0.2s; }

    .phone-frame { width: 360px; min-width: 360px; background: linear-gradient(180deg, #183340 0%, #0c1a20 100%); border-radius: 40px; border: 8px solid #000; box-shadow: 0 0 50px rgba(0,0,0,0.7); display: flex; flex-direction: column; position: relative; overflow: hidden; }
    .status-bar { padding: 20px 25px; font-size: 0.9rem; display: flex; justify-content: center; color: rgba(255,255,255,0.9); font-weight: 500; z-index: 10; height: 30px; }
    .status-bar.analyzing { color: #f1c40f; animation: blink 1s infinite; }
    .caller-info { margin-top: 20px; text-align: center; z-index: 10; height: 100px; }
    .caller-number { font-size: 2rem; font-weight: bold; margin-bottom: 5px; color: #fff; letter-spacing: 1px;}
    .caller-sub-number { font-size: 1.1rem; color: rgba(255, 255, 255, 0.7); margin-bottom: 5px; letter-spacing: 1.5px; }
    .caller-status { font-size: 0.9rem; color: #aabec6; transition: color 0.3s; }
    .risk-gauge-wrapper { position: relative; width: 200px; height: 200px; margin: 10px auto 30px auto; display: flex; justify-content: center; align-items: center; z-index: 5; }
    .gauge-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
    .gauge-bg { fill: none; stroke: rgba(255, 255, 255, 0.1); stroke-width: 12; }
    .gauge-progress { fill: none; stroke: #2ecc71; stroke-width: 12; stroke-linecap: round; stroke-dasharray: 565; stroke-dashoffset: 565; transition: stroke-dashoffset 0.8s cubic-bezier(0.4, 0, 0.2, 1), stroke 0.5s ease; }
    .gauge-text { position: absolute; text-align: center; }
    .risk-label { font-size: 1rem; color: #2ecc71; font-weight: bold; display: block; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 2px; transition: color 0.5s ease; }
    .risk-percent { font-size: 3rem; font-weight: bold; color: white; transition: color 0.5s ease; }
    .risk-gauge-wrapper.danger-active { animation: gauge-pulse 1s infinite; }
    .bottom-section { margin-top: auto; padding-bottom: 30px; display: flex; flex-direction: column; align-items: center; }
    .visualizer-area { height: 60px; display: flex; justify-content: center; align-items: center; opacity: 0.6; margin-bottom: 30px; }
    .wave { width: 6px; height: 10px; background: #64b5f6; margin: 0 6px; border-radius: 10px; animation: wave 1s infinite ease-in-out; display: none; }
    .wave:nth-child(2) { animation-delay: 0.1s; }
    .wave:nth-child(3) { animation-delay: 0.2s; }
    .wave:nth-child(4) { animation-delay: 0.3s; }
    .wave:nth-child(5) { animation-delay: 0.4s; }
    .action-btn-container { height: 80px; display: flex; justify-content: center; align-items: center; }
    #main-btn { width: 72px; height: 72px; border-radius: 50%; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); display: flex; align-items: center; justify-content: center; }
    .phone-icon { width: 32px; height: 32px; fill: white; pointer-events: none; transition: transform 0.3s ease; }
    #main-btn:hover { filter: brightness(1.1); transform: scale(1.05); }
    #main-btn.start-mode { background: linear-gradient(135deg, #00e676, #00c853); animation: pulse-ring-green 2s infinite; }
    #main-btn.start-mode .phone-icon { transform: rotate(0deg); }
    #main-btn.recording-mode { background: linear-gradient(135deg, #ff5252, #ff1744); animation: pulse-ring 2s infinite; }
    #main-btn.recording-mode .phone-icon { transform: rotate(135deg); }
    #menu-btn, #back-btn { position: absolute; top: 20px; background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 8px; color: white; cursor: pointer; z-index: 1000; padding: 8px; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
    #menu-btn { right: 30px; }
    #back-btn { left: 30px; }
    #menu-btn:hover, #back-btn:hover { background-color: rgba(255, 255, 255, 0.2); border-color: rgba(255, 255, 255, 0.8); }
    #history-sidebar { position: fixed; top: 0; right: -320px; width: 320px; height: 100vh; background-color: #1e1e1e; box-shadow: -5px 0 15px rgba(0,0,0,0.5); transition: right 0.3s ease-in-out; z-index: 999; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; }
    #history-sidebar.open { right: 0; }
    .sidebar-header { font-size: 1.2rem; font-weight: bold; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #444; margin-top: 50px; }
    #history-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
    .history-item { background-color: #2c2c2c; padding: 15px; margin-bottom: 10px; border-radius: 8px; cursor: pointer; border-left: 4px solid #666; transition: background 0.2s; }
    .history-item:hover { background-color: #3d3d3d; }
    .history-item.danger { border-left-color: #e74c3c; }
    .history-item.warning { border-left-color: #f1c40f; }
    .history-item.safe { border-left-color: #2ecc71; }
    .h-time { font-size: 0.8rem; color: #aaa; margin-bottom: 5px; display: block; }
    .h-preview { font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
    #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 900; display: none; opacity: 0; transition: opacity 0.3s; }
    #overlay.show { display: block; opacity: 1; }
    @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-15px); } 100% { transform: translateY(0px); } }
    @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-10px); } 60% { transform: translateY(-5px); } }
    @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(255, 59, 48, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0); } }
    @keyframes pulse-ring-green { 0% { box-shadow: 0 0 0 0 rgba(0, 200, 83, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(0, 200, 83, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 200, 83, 0); } }
    @keyframes wave { 0%, 100% { height: 10px; } 50% { height: 50px; } }
    @keyframes slideIn { from { transform: translateX(-10px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes gauge-pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }

    /* =========================================
       âœ… ë°˜ì‘í˜• ì¶”ê°€ (ì˜ë¦¼ ë°©ì§€ í•µì‹¬)
       - wrap + ì‘ì€ í™”ë©´ì—ì„œ ì„¸ë¡œ ìŠ¤íƒ + ìŠ¤í¬ë¡¤ í—ˆìš©
       ========================================= */
    .main-layout { flex-wrap: wrap; justify-content: center; align-content: flex-start; }
    .phone-frame { flex: 0 0 360px; }
    .side-panel { flex: 1 1 320px; min-width: 320px; max-width: 520px; }

    @media (max-width: 1250px) {
      body { overflow: auto; align-items: flex-start; }
      #app-container { align-items: flex-start; padding: 18px 0; height: auto; }
      .main-layout { height: auto; width: 92%; }
      .side-panel { max-height: 42vh; }
    }
    @media (max-width: 520px) {
      .main-layout { width: 94%; }
      .phone-frame { width: 100%; min-width: 0; flex: 1 1 auto; }
      .side-panel { min-width: 0; max-width: 100%; max-height: none; }
      #menu-btn { right: 16px; }
      #back-btn { left: 16px; }
    }
  </style>
</head>
<body>
  <div id="landing-page">
    <div class="hero-section">
      <div class="landing-icon">ğŸ›¡ï¸</div>
      <div class="landing-title">On-Device ë³´ì´ìŠ¤í”¼ì‹± íƒì§€</div>
      <p class="landing-subtitle">
        ì„œë²„ í†µì‹  ì—†ì´, ë¸Œë¼ìš°ì €ì—ì„œ ì¦‰ì‹œ ì‘ë™í•©ë‹ˆë‹¤.<br>
        ë‹¹ì‹ ì˜ ê°œì¸ì •ë³´ëŠ” ì™¸ë¶€ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
      </p>
      <button class="start-btn" onclick="startApp()">ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘í•˜ê¸°</button>
      <div class="scroll-hint" onclick="document.querySelector('.info-section').scrollIntoView({behavior: 'smooth'})">
        âŒ„ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤í•˜ì—¬ ë” ì•Œì•„ë³´ê¸°
      </div>
    </div>
    <div class="info-section">
      <div class="info-container">
        <h2 class="section-title">íŠ¹ì§•</h2>
        <div class="features-grid">
          <div class="feature-card">
            <span class="feature-icon">ğŸ”’</span>
            <h3 class="feature-title">ì™„ë²½í•œ ë³´ì•ˆ</h3>
            <p class="feature-desc">ìŒì„± ë°ì´í„°ê°€ ì„œë²„ë¡œ ì „ì†¡ë˜ì§€ ì•Šê³  ê¸°ê¸° ë‚´ì—ì„œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</p>
          </div>
          <div class="feature-card">
            <span class="feature-icon">âš¡</span>
            <h3 class="feature-title">ë¹ ë¥¸ ì‘ë‹µ ì†ë„</h3>
            <p class="feature-desc">ë„¤íŠ¸ì›Œí¬ ì§€ì—° ì—†ì´ ì‹¤ì‹œê°„ìœ¼ë¡œ ìœ„í—˜ì„ ê°ì§€í•©ë‹ˆë‹¤.</p>
          </div>
        </div>
      </div>
      <div class="footer">Â© 2024 AI Phishing Detector Simulator. All rights reserved.</div>
    </div>
  </div>

  <div id="app-container">
    <button id="back-btn" onclick="goBack()">
      <svg width="30" height="30" viewBox="0 0 24 24" fill="white">
        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
      </svg>
    </button>
    <button id="menu-btn" onclick="toggleSidebar()">
      <svg width="30" height="30" viewBox="0 0 24 24" fill="white">
        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
      </svg>
    </button>
    <div id="overlay" onclick="toggleSidebar()"></div>

    <div id="history-sidebar">
      <div class="sidebar-header">ğŸ“ í†µí™” ê¸°ë¡ (ë¡œì»¬ ì €ì¥)</div>
      <ul id="history-list">
        <li style="color:#666; font-size:0.9rem; text-align:center; padding:20px;">ê¸°ë¡ëœ í†µí™”ê°€ ì—†ìŠµë‹ˆë‹¤.</li>
      </ul>
    </div>

    <div class="main-layout">
      <!-- âœ… ë¡œê·¸ëŠ” ìœ ì§€ (thr/ê²½ë¡œ/ë””ë²„ê·¸ëŠ” ì•ˆ ì°ìŒ) -->
      <div class="side-panel">
        <h3>ğŸ›¡ï¸ On-Device ë¶„ì„ ë¡œê·¸</h3>
        <div id="analysis-log"><div class="log-item">ì‹œìŠ¤í…œ ëŒ€ê¸° ì¤‘...</div></div>
      </div>

      <div class="phone-frame">
        <div class="status-bar" id="status-bar"><span id="timer-display">HD Voice 00:00</span></div>
        <div class="caller-info">
          <div class="caller-number">í”¼í•´ì</div>
          <div class="caller-sub-number">010-****-****</div>
          <div class="caller-status" id="call-status-text">ëª¨ë¸ ë¡œë”© ì¤‘...</div>
        </div>

        <div class="risk-gauge-wrapper" id="gauge-wrapper">
          <svg class="gauge-svg" viewBox="0 0 200 200">
            <circle class="gauge-bg" cx="100" cy="100" r="90"></circle>
            <circle class="gauge-progress" id="gauge-progress" cx="100" cy="100" r="90"></circle>
          </svg>
          <div class="gauge-text">
            <span class="risk-label" id="risk-label">ì•ˆì „</span>
            <span class="risk-percent" id="risk-percent">0%</span>
          </div>
        </div>

        <div class="bottom-section">
          <div class="visualizer-area" id="wave-box">
            <div class="wave"></div><div class="wave"></div><div class="wave"></div><div class="wave"></div><div class="wave"></div>
          </div>
          <div class="action-btn-container">
            <button id="main-btn" class="start-mode" onclick="toggleCall()">
              <svg class="phone-icon" viewBox="0 0 24 24">
                <path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56a.977.977 0 00-1.01.24l-1.51 1.51a15.09 15.09 0 01-6.59-6.59l1.51-1.51a.977.977 0 00.24-1.01C8.79 6.43 8.59 5.24 8.59 4.01 8.59 3.45 8.14 3 7.59 3H4.01C3.45 3 3 3.45 3 4.01c0 9.37 7.62 17 17 17 .56 0 1.01-.45 1.01-1.01v-3.58c0-.56-.45-1.01-1.01-1.01z"/>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <div class="side-panel">
        <h3>ğŸ’¬ ì‹¤ì‹œê°„ ëŒ€í™” ê¸°ë¡</h3>
        <div id="transcript-box"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { AutoTokenizer, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';

    const MIN_UTTER_LEN = 32;
    const EWMA_ALPHA = 0.7;

    env.allowLocalModels = true;
    env.allowRemoteModels = false;
    env.useBrowserCache = false;
    env.localModelPath = './';

    const mainBtn = document.getElementById('main-btn');
    const statusText = document.getElementById('call-status-text');
    const statusBar = document.getElementById('status-bar');
    const transcriptBox = document.getElementById('transcript-box');
    const analysisLog = document.getElementById('analysis-log');
    const timerDisplay = document.getElementById('timer-display');
    const sidebar = document.getElementById('history-sidebar');
    const overlay = document.getElementById('overlay');
    const historyList = document.getElementById('history-list');
    const gaugeProgress = document.getElementById('gauge-progress');
    const riskLabel = document.getElementById('risk-label');
    const riskPercent = document.getElementById('risk-percent');
    const gaugeWrapper = document.getElementById('gauge-wrapper');
    const waves = document.querySelectorAll('.wave');

    const CIRCUMFERENCE = 565;
    gaugeProgress.style.strokeDasharray = CIRCUMFERENCE;

    let recognition;
    let isRecording = false;
    let timerInterval;
    let seconds = 0;
    let historyData = [];
    let currentSession = null;
    let currentRiskScore = 0;
    let utterBuffer = "";

    let LOW_THR = 0.2;
    let HIGH_THR = 0.9;

    function addLog(text, type) {
      if (!analysisLog) return;
      const div = document.createElement('div');
      let className = 'log-item';
      if (type === 'danger') className += ' log-danger';
      if (type === 'warning') className += ' log-warning';
      if (type === 'safe') className += ' log-safe';
      if (type === 'send') className += ' log-send';
      div.className = className;
      div.innerText = `[${new Date().toLocaleTimeString()}] ${text}`;
      analysisLog.appendChild(div);
      analysisLog.scrollTop = analysisLog.scrollHeight;
    }

    function normalizePath(p) {
      if (!p) return p;
      return p.replaceAll('\\', '/');
    }

    async function fetchFirst(paths) {
      for (const p of paths) {
        try {
          const res = await fetch(p, { cache: 'no-store' });
          if (res.ok) return { path: p, json: await res.json() };
        } catch {}
      }
      return null;
    }

    function clamp01(x) {
      if (!Number.isFinite(x)) return 0;
      if (x < 0) return 0;
      if (x > 1) return 1;
      return x;
    }
    function sigmoid(x) { return 1 / (1 + Math.exp(-x)); }
    function probFromRaw(raw) {
      if (raw >= 0 && raw <= 1) return raw;
      return sigmoid(raw);
    }
    function labelByThreshold(prob) {
      if (prob >= HIGH_THR) return 'danger';
      if (prob >= LOW_THR) return 'warning';
      return 'safe';
    }

    function updateGaugeUI(score, level) {
      score = Math.max(0, Math.min(100, score));
      riskPercent.innerText = `${score}%`;
      const offset = CIRCUMFERENCE - (score / 100) * CIRCUMFERENCE;
      gaugeProgress.style.strokeDashoffset = offset;

      if (level === 'danger') {
        riskLabel.innerText = "ìœ„í—˜";
        riskLabel.style.color = "#e74c3c";
        gaugeProgress.style.stroke = "#e74c3c";
        riskPercent.style.color = "#e74c3c";
        gaugeWrapper.classList.add('danger-active');
      } else if (level === 'warning') {
        riskLabel.innerText = "ì£¼ì˜";
        riskLabel.style.color = "#f1c40f";
        gaugeProgress.style.stroke = "#f1c40f";
        riskPercent.style.color = "#f1c40f";
        gaugeWrapper.classList.remove('danger-active');
      } else {
        riskLabel.innerText = "ì•ˆì „";
        riskLabel.style.color = "#2ecc71";
        gaugeProgress.style.stroke = "#2ecc71";
        riskPercent.style.color = "#2ecc71";
        gaugeWrapper.classList.remove('danger-active');
      }
    }

    class RealLocalModel {
      constructor() {
        this.isReady = false;
        this.tokenizer = null;
        this.embedSession = null;
        this.predSession = null;
        this.embedInputs = null;
        this.embedOutName = null;
        this.predInName = null;
        this.predOutName = null;
        this.contextVec = null;
        this.turn = 0;
        this.init();
      }

      resetContext() {
        this.contextVec = null;
        this.turn = 0;
      }

      _l2normalize(vec) {
        let s = 0;
        for (let i = 0; i < vec.length; i++) s += vec[i] * vec[i];
        const n = Math.sqrt(s) || 1.0;
        for (let i = 0; i < vec.length; i++) vec[i] /= n;
        return vec;
      }

      _meanPool(lastHidden, attnMask, seqLen, dim) {
        const out = new Float32Array(dim);
        let cnt = 0;
        for (let t = 0; t < seqLen; t++) {
          if (attnMask[t] === 0) continue;
          const base = t * dim;
          for (let d = 0; d < dim; d++) out[d] += lastHidden[base + d];
          cnt++;
        }
        const denom = cnt || 1;
        for (let d = 0; d < dim; d++) out[d] /= denom;
        return out;
      }

      _toIntTensor(arr, shape, prefer='int64') {
        if (prefer === 'int64') {
          const big = new BigInt64Array(arr.length);
          for (let i = 0; i < arr.length; i++) big[i] = BigInt(arr[i]);
          return new ort.Tensor('int64', big, shape);
        } else {
          return new ort.Tensor('int32', new Int32Array(arr), shape);
        }
      }

      async _loadConfig() {
        const cfgTry = await fetchFirst([
          './models/predict/ensemble_config.json',
          './scores_ens/ensemble_config.json',
          './ensemble_config.json',
        ]);
        if (!cfgTry) throw new Error("cfg fail");

        const cfg = cfgTry.json;
        LOW_THR = Number(cfg.low_thr);
        HIGH_THR = Number(cfg.high_thr);

        const onnxPathFromCfg = normalizePath(cfg.onnx_calibrated_path);
        return { onnxPathFromCfg };
      }

      async _createSessionFirst(paths) {
        let lastErr = null;
        for (const p of paths) {
          try {
            return await ort.InferenceSession.create(p);
          } catch (e) { lastErr = e; }
        }
        throw lastErr ?? new Error("onnx fail");
      }

      async init() {
        addLog("â³ ëª¨ë¸ ë¡œë”© ì¤‘...", "send");
        try {
          const { onnxPathFromCfg } = await this._loadConfig();

          this.tokenizer = await AutoTokenizer.from_pretrained('models/embedding', { local_files_only: true });

          const embedPaths = [
            './models/embedding/onnx/embeddings.onnx',
            './models/embedding/embeddings.onnx',
            './embeddings.onnx',
          ];
          this.embedSession = await this._createSessionFirst(embedPaths);
          this.embedInputs = this.embedSession.inputNames;
          this.embedOutName = this.embedSession.outputNames[0];

          const predPaths = [
            onnxPathFromCfg,
            './models/predict/onnx/ensemble_prob_calibrated.onnx',
            './predict/ensemble_prob_calibrated.onnx',
            './ensemble_prob_calibrated.onnx',
            './models/predict/onnx/predict.onnx',
            './models/predict/predict.onnx',
            './predict.onnx',
          ].filter(Boolean).map(normalizePath);

          this.predSession = await this._createSessionFirst(predPaths);
          this.predInName = this.predSession.inputNames[0];
          this.predOutName = this.predSession.outputNames[0];

          this.isReady = true;

          addLog("âœ… AI ê°ì‹œ ì¤€ë¹„ ì™„ë£Œ", "safe");
          statusText.innerText = "AI ê°ì‹œ ì¤€ë¹„ë¨";
          statusText.style.color = "#2ecc71";
        } catch {
          addLog("âŒ ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨", "danger");
          statusText.innerText = "ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨";
          statusText.style.color = "#e74c3c";
        }
      }

      async _embed(text) {
        const prefixed = "query: " + text;
        const tok = await this.tokenizer(prefixed, { padding: true, truncation: true, max_length: 128 });

        const input_ids = tok.input_ids;
        const attention_mask = tok.attention_mask;
        const seqLen = input_ids.length;

        const feedsTry = (dtype) => {
          const feeds = {};
          const shape = [1, seqLen];
          if (this.embedInputs.includes('input_ids')) feeds['input_ids'] = this._toIntTensor(input_ids, shape, dtype);
          if (this.embedInputs.includes('attention_mask')) feeds['attention_mask'] = this._toIntTensor(attention_mask, shape, dtype);
          if (this.embedInputs.includes('token_type_ids')) feeds['token_type_ids'] = this._toIntTensor(new Array(seqLen).fill(0), shape, dtype);
          return feeds;
        };

        let results;
        try { results = await this.embedSession.run(feedsTry('int64')); }
        catch { results = await this.embedSession.run(feedsTry('int32')); }

        const out = results[this.embedOutName];
        const dims = out.dims;

        if (dims.length === 2) return this._l2normalize(Float32Array.from(out.data));
        if (dims.length === 3) {
          const dim = dims[2];
          const pooled = this._meanPool(out.data, attention_mask, seqLen, dim);
          return this._l2normalize(pooled);
        }
        throw new Error("embed dims");
      }

      async predict(text) {
        const cur = await this._embed(text);

        if (this.contextVec === null) {
          this.contextVec = Float32Array.from(cur);
        } else {
          for (let i = 0; i < this.contextVec.length; i++) {
            this.contextVec[i] = EWMA_ALPHA * cur[i] + (1 - EWMA_ALPHA) * this.contextVec[i];
          }
          this._l2normalize(this.contextVec);
        }
        this.turn += 1;

        const x = new ort.Tensor('float32', this.contextVec, [1, this.contextVec.length]);
        const res = await this.predSession.run({ [this.predInName]: x });

        const raw = res[this.predOutName].data[0];
        const prob = clamp01(probFromRaw(raw));
        const level = labelByThreshold(prob);
        const score = Math.round(prob * 100);

        return { prob, score, level, depth: this.turn };
      }
    }

    const localModel = new RealLocalModel();

    // SpeechRecognition
    window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (window.SpeechRecognition) {
      recognition = new window.SpeechRecognition();
      recognition.lang = 'ko-KR';
      recognition.continuous = true;
      recognition.interimResults = false;

      recognition.addEventListener('result', async (e) => {
        const chunk = e.results[e.results.length - 1][0].transcript?.trim();
        if (!chunk || !isRecording) return;

        // âœ… 32ì ëˆ„ì  -> 1ë°œí™”
        utterBuffer = utterBuffer ? (utterBuffer + " " + chunk) : chunk;
        if (utterBuffer.length < MIN_UTTER_LEN) return;

        const utter = utterBuffer;
        utterBuffer = "";

        addTranscript(utter);
        await analyzeTextLocally(utter);
      });

      // âœ… ë§ˆì´í¬ ê²½ê³ /ë””ë²„ê·¸ UI í‘œì‹œ X (ì¡°ìš©íˆ ì¬ì‹œì‘ë§Œ)
      recognition.addEventListener('error', () => {
        if (isRecording) {
          try { recognition.stop(); } catch {}
          setTimeout(() => { if (isRecording) { try { recognition.start(); } catch {} } }, 600);
        }
      });

      recognition.addEventListener('end', () => {
        if (isRecording) setTimeout(() => { try { recognition.start(); } catch {} }, 300);
      });
    } else {
      addLog("âš ï¸ ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.", "warning");
    }

    async function analyzeTextLocally(text) {
      addLog("ğŸ¤ ë°œí™” ë¶„ì„ ì¤‘...", "send");
      if (!localModel.isReady) { addLog("â³ ëª¨ë¸ ì¤€ë¹„ ì¤‘...", "warning"); return; }

      statusBar.classList.add('analyzing');
      try {
        const result = await localModel.predict(text);
        if (!result) return;

        currentRiskScore = result.score;
        updateGaugeUI(currentRiskScore, result.level);

        const ptxt = (result.prob * 100).toFixed(1);
        if (result.level === 'danger') addLog(`ğŸš¨ ìœ„í—˜ ê°ì§€ (${ptxt}%)`, 'danger');
        else if (result.level === 'warning') addLog(`âš ï¸ ì˜ì‹¬ íŒ¨í„´ (${ptxt}%)`, 'warning');
        else addLog(`âœ… ì •ìƒ (${ptxt}%)`, 'safe');

        if (currentSession) {
          currentSession.finalRisk = currentRiskScore;
          if (result.level === 'danger') currentSession.isDanger = true;
        }
        if (isRecording) statusText.innerText = `AI ê°ì‹œ ì¤‘`;
      } catch {
        addLog("âš ï¸ ë¶„ì„ ì‹¤íŒ¨", "warning");
      } finally {
        statusBar.classList.remove('analyzing');
      }
    }

    // UI Helpers
    function startApp() { document.getElementById('landing-page').style.display = 'none'; document.getElementById('app-container').style.display = 'flex'; }
    function goBack() { if (isRecording) toggleCall(); document.getElementById('app-container').style.display = 'none'; document.getElementById('landing-page').style.display = 'flex'; }

    function startTimer() { seconds = 0; timerDisplay.innerText = "00:00"; timerInterval = setInterval(() => { seconds++; timerDisplay.innerText = formatTime(seconds); }, 1000); }
    function stopTimer() { clearInterval(timerInterval); timerDisplay.innerText = "HD Voice 00:00"; }
    function formatTime(sec) { const m = Math.floor(sec / 60); const s = sec % 60; return `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`; }
    function startWaveAnimation() { waves.forEach(w => w.style.display = "block"); }
    function stopWaveAnimation() { waves.forEach(w => w.style.display = "none"); }

    function addTranscript(text) {
      const div = document.createElement('div');
      div.className = 'transcript-bubble';
      div.innerText = text;
      transcriptBox.appendChild(div);
      transcriptBox.scrollTop = transcriptBox.scrollHeight;
    }

    async function toggleCall() {
      if (!recognition) return;

      if (!isRecording) {
        if (!localModel.isReady) { alert("ëª¨ë¸ ë¡œë”© ì¤‘..."); return; }

        transcriptBox.innerHTML = '';
        analysisLog.innerHTML = '';
        addLog("ğŸ”µ í†µí™” ì—°ê²°ë¨", "safe");

        utterBuffer = "";
        localModel.resetContext();
        currentRiskScore = 0;
        updateGaugeUI(0, 'safe');

        currentSession = { id: Date.now(), startTime: new Date().toLocaleString(), duration: 0, isDanger: false, finalRisk: 0 };

        try { recognition.start(); } catch {}
        isRecording = true;
        mainBtn.className = 'recording-mode';
        statusText.innerText = "AI ê°ì‹œ ì¤‘";
        statusText.style.color = "#64b5f6";
        startWaveAnimation();
        startTimer();
      } else {
        try { recognition.stop(); } catch {}
        isRecording = false;
        mainBtn.className = 'start-mode';
        addLog("â¹ï¸ í†µí™” ì¢…ë£Œ", "send");

        utterBuffer = "";

        if (currentSession) {
          currentSession.duration = seconds;
          currentSession.finalRisk = currentRiskScore;
          historyData.push(currentSession);
          renderHistoryList();
        }
        stopWaveAnimation();
        stopTimer();

        statusText.innerText = "ì—°ê²° ëŒ€ê¸° ì¤‘";
        statusText.style.color = "#aabec6";
      }
    }

    function toggleSidebar() { sidebar.classList.toggle('open'); overlay.classList.toggle('show'); }
    function renderHistoryList() {
      historyList.innerHTML = '';
      [...historyData].reverse().forEach(session => {
        const li = document.createElement('li');
        li.className = `history-item ${session.finalRisk >= 95 ? 'danger' : (session.finalRisk >= 80 ? 'warning' : 'safe')}`;
        li.innerHTML = `<span class="h-time">${session.startTime}</span><span class="h-preview">ìµœì¢…: ${session.finalRisk}%</span>`;
        historyList.appendChild(li);
      });
    }

    window.startApp = startApp;
    window.goBack = goBack;
    window.toggleCall = toggleCall;
    window.toggleSidebar = toggleSidebar;
  </script>
</body>
</html>
