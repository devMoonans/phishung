<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í”¼ì‹± íƒì§€ ì‹œë®¬ë ˆì´í„° - On-Device AI</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <style>
        /* =========================================
           ë””ìì¸(CSS)ì€ ì›ë³¸ê³¼ 100% ë™ì¼í•©ë‹ˆë‹¤.
           ========================================= */
        body { background-color: #121212; color: white; font-family: 'Apple SD Gothic Neo', sans-serif; margin: 0; height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        #landing-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); z-index: 2000; overflow-y: auto; transition: opacity 0.5s ease; display: flex; flex-direction: column; align-items: center; }
        .hero-section { min-height: 100vh; width: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; position: relative; }
        .landing-icon { font-size: 5rem; margin-bottom: 20px; animation: float 3s ease-in-out infinite; }
        .landing-title { font-size: 3rem; font-weight: bold; margin-bottom: 10px; background: linear-gradient(to right, #4facfe 0%, #00f2fe 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .landing-subtitle { font-size: 1.2rem; color: #ccc; margin-bottom: 40px; max-width: 600px; line-height: 1.6; }
        .start-btn { padding: 15px 40px; font-size: 1.2rem; font-weight: bold; color: white; background: linear-gradient(45deg, #4facfe, #00f2fe); border: none; border-radius: 30px; cursor: pointer; box-shadow: 0 10px 20px rgba(0, 242, 254, 0.3); transition: transform 0.2s, box-shadow 0.2s; margin-bottom: 20px; }
        .start-btn:hover { transform: translateY(-3px); box-shadow: 0 15px 25px rgba(0, 242, 254, 0.5); }
        .scroll-hint { position: absolute; bottom: 30px; color: rgba(255,255,255,0.5); animation: bounce 2s infinite; font-size: 0.9rem; cursor: pointer; }
        .info-section { width: 100%; padding: 80px 20px; background: rgba(0,0,0,0.2); text-align: center; box-sizing: border-box; }
        .info-container { max-width: 1000px; margin: 0 auto; }
        .section-title { font-size: 2rem; margin-bottom: 50px; color: #fff; position: relative; display: inline-block; }
        .section-title::after { content: ''; display: block; width: 60%; height: 3px; background: #4facfe; margin: 10px auto 0; border-radius: 2px; }
        .features-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px; text-align: left; }
        .feature-card { background: rgba(255,255,255,0.05); padding: 30px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); transition: transform 0.3s ease; }
        .feature-card:hover { transform: translateY(-5px); background: rgba(255,255,255,0.1); }
        .feature-icon { font-size: 2.5rem; margin-bottom: 20px; display: block; }
        .feature-title { font-size: 1.3rem; font-weight: bold; margin-bottom: 10px; color: #81d4fa; }
        .feature-desc { font-size: 0.95rem; color: #ccc; line-height: 1.6; }
        .footer { padding: 40px; text-align: center; font-size: 0.8rem; color: #666; background: rgba(0,0,0,0.3); width: 100%; box-sizing: border-box; }
        #app-container { display: none; width: 100%; height: 100%; justify-content: center; align-items: center; animation: fadeIn 1s ease; }
        .main-layout { display: flex; width: 95%; max-width: 1400px; height: 85vh; gap: 20px; transition: transform 0.3s ease; }
        .side-panel { flex: 1; background: rgba(255, 255, 255, 0.05); border-radius: 20px; padding: 20px; display: flex; flex-direction: column; border: 1px solid rgba(255, 255, 255, 0.1); }
        h3 { margin-top: 0; color: #aaa; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #444; padding-bottom: 10px;}
        #analysis-log { flex: 1; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.85rem; display: flex; flex-direction: column; gap: 8px; }
        .log-item { padding: 8px; background: rgba(0, 0, 0, 0.3); border-left: 3px solid #4a90e2; border-radius: 4px; animation: slideIn 0.3s ease; }
        .log-warning { border-left-color: #f1c40f; background: rgba(241, 196, 15, 0.1); color: #f1c40f; }
        .log-danger { border-left-color: #e74c3c; background: rgba(231, 76, 60, 0.1); color: #ffadad; font-weight: bold; }
        .log-safe { border-color: #2ecc71; color: #abebc6; }
        .log-send { border-left-color: #999; color: #bbb; background: rgba(255,255,255,0.05); }
        #transcript-box { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .transcript-bubble { background: #2c3e50; padding: 12px; border-radius: 12px; font-size: 1rem; line-height: 1.4; animation: fadeIn 0.3s; position: relative; transition: all 0.2s; }
        .transcript-bubble.playable { cursor: pointer; border: 1px solid transparent; transition: background 0.2s, border-color 0.2s; }
        .transcript-bubble.playable:hover { background: #34495e; border-color: #4facfe; }
        .transcript-bubble.playable.playing { background: #1f4068; border-color: #00f2fe; box-shadow: 0 0 10px rgba(0, 242, 254, 0.3); }
        .transcript-bubble.playable:hover::after { content: 'â–¶ ì¬ìƒ'; position: absolute; top: 5px; right: 8px; background: rgba(79, 172, 254, 0.9); color: white; font-size: 0.7rem; padding: 3px 8px; border-radius: 10px; pointer-events: none; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .phone-frame { width: 360px; min-width: 360px; background: linear-gradient(180deg, #183340 0%, #0c1a20 100%); border-radius: 40px; border: 8px solid #000; box-shadow: 0 0 50px rgba(0,0,0,0.7); display: flex; flex-direction: column; position: relative; overflow: hidden; }
        .status-bar { padding: 20px 25px; font-size: 0.9rem; display: flex; justify-content: center; color: rgba(255,255,255,0.9); font-weight: 500; z-index: 10; height: 30px; }
        .status-bar.analyzing { color: #f1c40f; animation: blink 1s infinite; }
        .caller-info { margin-top: 20px; text-align: center; z-index: 10; height: 100px; }
        .caller-number { font-size: 2rem; font-weight: bold; margin-bottom: 5px; color: #fff; letter-spacing: 1px;}
        .caller-sub-number { font-size: 1.1rem; color: rgba(255, 255, 255, 0.7); margin-bottom: 5px; letter-spacing: 1.5px; }
        .caller-status { font-size: 0.9rem; color: #aabec6; transition: color 0.3s; }
        .risk-gauge-wrapper { position: relative; width: 200px; height: 200px; margin: 10px auto 30px auto; display: flex; justify-content: center; align-items: center; z-index: 5; }
        .gauge-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .gauge-bg { fill: none; stroke: rgba(255, 255, 255, 0.1); stroke-width: 12; }
        .gauge-progress { fill: none; stroke: #2ecc71; stroke-width: 12; stroke-linecap: round; stroke-dasharray: 565; stroke-dashoffset: 565; transition: stroke-dashoffset 0.8s cubic-bezier(0.4, 0, 0.2, 1), stroke 0.5s ease; }
        .gauge-text { position: absolute; text-align: center; }
        .risk-label { font-size: 1rem; color: #2ecc71; font-weight: bold; display: block; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 2px; transition: color 0.5s ease; }
        .risk-percent { font-size: 3rem; font-weight: bold; color: white; transition: color 0.5s ease; }
        .risk-gauge-wrapper.danger-active { animation: gauge-pulse 1s infinite; }
        .bottom-section { margin-top: auto; padding-bottom: 30px; display: flex; flex-direction: column; align-items: center; }
        .visualizer-area { height: 60px; display: flex; justify-content: center; align-items: center; opacity: 0.6; margin-bottom: 30px; }
        .wave { width: 6px; height: 10px; background: #64b5f6; margin: 0 6px; border-radius: 10px; animation: wave 1s infinite ease-in-out; display: none; }
        .wave:nth-child(2) { animation-delay: 0.1s; }
        .wave:nth-child(3) { animation-delay: 0.2s; }
        .wave:nth-child(4) { animation-delay: 0.3s; }
        .wave:nth-child(5) { animation-delay: 0.4s; }
        .action-btn-container { height: 80px; display: flex; justify-content: center; align-items: center; }
        #main-btn { width: 72px; height: 72px; border-radius: 50%; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); display: flex; align-items: center; justify-content: center; }
        .phone-icon { width: 32px; height: 32px; fill: white; pointer-events: none; transition: transform 0.3s ease; }
        #main-btn:hover { filter: brightness(1.1); transform: scale(1.05); }
        #main-btn.start-mode { background: linear-gradient(135deg, #00e676, #00c853); animation: pulse-ring-green 2s infinite; }
        #main-btn.start-mode .phone-icon { transform: rotate(0deg); }
        #main-btn.recording-mode { background: linear-gradient(135deg, #ff5252, #ff1744); animation: pulse-ring 2s infinite; }
        #main-btn.recording-mode .phone-icon { transform: rotate(135deg); }
        #menu-btn, #back-btn { position: absolute; top: 20px; background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 8px; color: white; cursor: pointer; z-index: 1000; padding: 8px; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
        #menu-btn { right: 30px; }
        #back-btn { left: 30px; }
        #menu-btn:hover, #back-btn:hover { background-color: rgba(255, 255, 255, 0.2); border-color: rgba(255, 255, 255, 0.8); }
        #history-sidebar { position: fixed; top: 0; right: -320px; width: 320px; height: 100vh; background-color: #1e1e1e; box-shadow: -5px 0 15px rgba(0,0,0,0.5); transition: right 0.3s ease-in-out; z-index: 999; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; }
        #history-sidebar.open { right: 0; }
        .sidebar-header { font-size: 1.2rem; font-weight: bold; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #444; margin-top: 50px; }
        #history-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        .history-item { background-color: #2c2c2c; padding: 15px; margin-bottom: 10px; border-radius: 8px; cursor: pointer; border-left: 4px solid #666; transition: background 0.2s; }
        .history-item:hover { background-color: #3d3d3d; }
        .history-item.danger { border-left-color: #e74c3c; }
        .history-item.warning { border-left-color: #f1c40f; }
        .history-item.safe { border-left-color: #2ecc71; }
        .h-time { font-size: 0.8rem; color: #aaa; margin-bottom: 5px; display: block; }
        .h-preview { font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 900; display: none; opacity: 0; transition: opacity 0.3s; }
        #overlay.show { display: block; opacity: 1; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-15px); } 100% { transform: translateY(0px); } }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 40% { transform: translateY(-10px); } 60% { transform: translateY(-5px); } }
        @keyframes pulse-ring { 0% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(255, 59, 48, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0); } }
        @keyframes pulse-ring-green { 0% { box-shadow: 0 0 0 0 rgba(0, 200, 83, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(0, 200, 83, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 200, 83, 0); } }
        @keyframes wave { 0%, 100% { height: 10px; } 50% { height: 50px; } }
        @keyframes slideIn { from { transform: translateX(-10px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes gauge-pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
    </style>
</head>
<body>
    <div id="landing-page">
        <div class="hero-section">
            <div class="landing-icon">ğŸ›¡ï¸</div>
            <div class="landing-title">On-Device ë³´ì´ìŠ¤í”¼ì‹± íƒì§€</div>
            <p class="landing-subtitle">
                ì„œë²„ í†µì‹  ì—†ì´, ë¸Œë¼ìš°ì €ì—ì„œ ì¦‰ì‹œ ì‘ë™í•©ë‹ˆë‹¤.<br>
                ë‹¹ì‹ ì˜ ê°œì¸ì •ë³´ëŠ” ì™¸ë¶€ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            </p>
            <button class="start-btn" onclick="startApp()">ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘í•˜ê¸°</button>
            <div class="scroll-hint" onclick="document.querySelector('.info-section').scrollIntoView({behavior: 'smooth'})">
                âŒ„ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤í•˜ì—¬ ë” ì•Œì•„ë³´ê¸°
            </div>
        </div>
        <div class="info-section">
            <div class="info-container">
                <h2 class="section-title">íŠ¹ì§•</h2>
                <div class="features-grid">
                    <div class="feature-card">
                        <span class="feature-icon">ğŸ”’</span>
                        <h3 class="feature-title">ì™„ë²½í•œ ë³´ì•ˆ</h3>
                        <p class="feature-desc">ìŒì„± ë°ì´í„°ê°€ ì„œë²„ë¡œ ì „ì†¡ë˜ì§€ ì•Šê³  ê¸°ê¸° ë‚´ì—ì„œ ì²˜ë¦¬ë©ë‹ˆë‹¤.</p>
                    </div>
                    <div class="feature-card">
                        <span class="feature-icon">âš¡</span>
                        <h3 class="feature-title">ë¹ ë¥¸ ì‘ë‹µ ì†ë„</h3>
                        <p class="feature-desc">ë„¤íŠ¸ì›Œí¬ ì§€ì—° ì—†ì´ ì‹¤ì‹œê°„ìœ¼ë¡œ ìœ„í—˜ì„ ê°ì§€í•©ë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
            <div class="footer">Â© 2024 AI Phishing Detector Simulator. All rights reserved.</div>
        </div>
    </div>

    <div id="app-container">
        <button id="back-btn" onclick="goBack()"><svg width="30" height="30" viewBox="0 0 24 24" fill="white"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button>
        <button id="menu-btn" onclick="toggleSidebar()"><svg width="30" height="30" viewBox="0 0 24 24" fill="white"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></button>
        <div id="overlay" onclick="toggleSidebar()"></div>

        <div id="history-sidebar">
            <div class="sidebar-header">ğŸ“ í†µí™” ê¸°ë¡ (ë¡œì»¬ ì €ì¥)</div>
            <ul id="history-list"><li style="color:#666; font-size:0.9rem; text-align:center; padding:20px;">ê¸°ë¡ëœ í†µí™”ê°€ ì—†ìŠµë‹ˆë‹¤.</li></ul>
        </div>

        <div class="main-layout">
            <div class="side-panel">
                <h3>ğŸ›¡ï¸ On-Device ë¶„ì„ ë¡œê·¸</h3>
                <div id="analysis-log"><div class="log-item">ì‹œìŠ¤í…œ ëŒ€ê¸° ì¤‘...</div></div>
            </div>

            <div class="phone-frame">
                <div class="status-bar" id="status-bar"><span id="timer-display">HD Voice 00:00</span></div>
                <div class="caller-info">
                    <div class="caller-number">í”¼í•´ì</div>
                    <div class="caller-sub-number">010-****-****</div>
                    <div class="caller-status" id="call-status-text">ì—°ê²° ëŒ€ê¸° ì¤‘</div>
                </div>

                <div class="risk-gauge-wrapper" id="gauge-wrapper">
                    <svg class="gauge-svg" viewBox="0 0 200 200">
                        <circle class="gauge-bg" cx="100" cy="100" r="90"></circle>
                        <circle class="gauge-progress" id="gauge-progress" cx="100" cy="100" r="90"></circle>
                    </svg>
                    <div class="gauge-text">
                        <span class="risk-label" id="risk-label">ì•ˆì „</span>
                        <span class="risk-percent" id="risk-percent">0%</span>
                    </div>
                </div>

                <div class="bottom-section">
                    <div class="visualizer-area" id="wave-box">
                        <div class="wave"></div><div class="wave"></div><div class="wave"></div><div class="wave"></div><div class="wave"></div>
                    </div>
                    <div class="action-btn-container">
                        <button id="main-btn" class="start-mode" onclick="toggleCall()">
                            <svg class="phone-icon" viewBox="0 0 24 24">
                                <path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56a.977.977 0 00-1.01.24l-1.51 1.51a15.09 15.09 0 01-6.59-6.59l1.51-1.51a.977.977 0 00.24-1.01C8.79 6.43 8.59 5.24 8.59 4.01 8.59 3.45 8.14 3 7.59 3H4.01C3.45 3 3 3.45 3 4.01c0 9.37 7.62 17 17 17 .56 0 1.01-.45 1.01-1.01v-3.58c0-.56-.45-1.01-1.01-1.01z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="side-panel">
                <h3>ğŸ’¬ ì‹¤ì‹œê°„ ëŒ€í™” ê¸°ë¡</h3>
                <div id="transcript-box"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';

        // ==========================================
        // 1. [ì„¤ì •] ê²½ë¡œ ë° ëª¨ë¸ ì„¤ì •
        // ==========================================
        env.allowLocalModels = true;
        env.useBrowserCache = false;

        // â˜… ì¤‘ìš”: ëª¨ë¸ì„ í˜„ì¬ í´ë”('./') ê¸°ì¤€ìœ¼ë¡œ ì°¾ë„ë¡ ì„¤ì •
        env.localModelPath = './';

        // UI ìš”ì†Œ
        const mainBtn = document.getElementById('main-btn');
        const statusText = document.getElementById('call-status-text');
        const statusBar = document.getElementById('status-bar');
        const transcriptBox = document.getElementById('transcript-box');
        const analysisLog = document.getElementById('analysis-log');
        const timerDisplay = document.getElementById('timer-display');
        const sidebar = document.getElementById('history-sidebar');
        const overlay = document.getElementById('overlay');
        const historyList = document.getElementById('history-list');
        const gaugeProgress = document.getElementById('gauge-progress');
        const riskLabel = document.getElementById('risk-label');
        const riskPercent = document.getElementById('risk-percent');
        const gaugeWrapper = document.getElementById('gauge-wrapper');
        const waveBox = document.getElementById('wave-box');
        const waves = document.querySelectorAll('.wave');
        const CIRCUMFERENCE = 565;
        gaugeProgress.style.strokeDasharray = CIRCUMFERENCE;

        // ë³€ìˆ˜
        let recognition;
        let isRecording = false;
        let timerInterval;
        let seconds = 0;
        let historyData = [];
        let currentSession = null;
        let currentRiskScore = 0;

        // ==========================================
        // 2. ëª¨ë¸ í´ë˜ìŠ¤ ì •ì˜
        // ==========================================
        class RealLocalModel {
  constructor() {
    this.isReady = false;
    this.embedder = null;
    this.classifier = null;

    // âœ… ëˆ„ì  ì»¨í…ìŠ¤íŠ¸
    this.contextVec = null;
    this.turn = 0;

    this.init(); // <- initì´ í´ë˜ìŠ¤ ì•ˆì— ìˆì–´ì•¼ í•¨
  }

  async init() {
    addLog("â³ [1/2] ë¡œì»¬ ì„ë² ë”© ëª¨ë¸ ë¡œë”© ì¤‘...", "send");

    try {
      this.embedder = await pipeline('feature-extraction', 'web_embedding_model', {
        local_files_only: true,
        quantized: false
      });
      addLog("âœ… ì„ë² ë”© ëª¨ë¸ ë¡œë“œ ì„±ê³µ!", "safe");

      addLog("â³ [2/2] ë¶„ë¥˜ê¸° ë¡œë“œ ì¤‘...", "send");
      this.classifier = await ort.InferenceSession.create('./classifier.onnx');

      this.isReady = true;
      addLog("ğŸš€ ëª¨ë“  AI ëª¨ë¸ ì¤€ë¹„ ì™„ë£Œ! ê°ì‹œ ëŒ€ê¸° ì¤‘.", "safe");

      if (statusText) {
        statusText.innerText = "AI ê°ì‹œ ì¤€ë¹„ë¨";
        statusText.style.color = "#2ecc71";
      }

    } catch (e) {
      addLog("âŒ ëª¨ë¸ ë¡œë“œ ì—ëŸ¬: " + e.message, "danger");
      if (e.message.includes("404")) {
        addLog("ğŸ’¡ íŒíŠ¸: 'python -m http.server' ëª…ë ¹ì–´ë¡œ ì„œë²„ë¥¼ ì¼°ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.", "warning");
      }
      console.error(e);
    }
  }

  resetContext() {
    this.contextVec = null;
    this.turn = 0;
    addLog("ğŸ§¹ ëŒ€í™” ë§¥ë½ ì´ˆê¸°í™”ë¨", "safe");
  }

  async predict(text) {
    if (!this.isReady) return null;

    try {
      const output = await this.embedder("query: " + text, { pooling: 'mean', normalize: true });
      const currentVec = output.data;

      const alpha = 0.7;     // í˜„ì¬ 0.7
      const prevW = 0.3;     // ì´ì „ 0.3

      if (this.contextVec === null) {
        this.contextVec = Float32Array.from(currentVec);
      } else {
        const len = this.contextVec.length;
        for (let j = 0; j < len; j++) {
          this.contextVec[j] = alpha * currentVec[j] + prevW * this.contextVec[j];
        }
      }

      // ì •ê·œí™”
      let norm = 0;
      for (let j = 0; j < this.contextVec.length; j++) norm += this.contextVec[j] * this.contextVec[j];
      norm = Math.sqrt(norm) || 1.0;
      for (let j = 0; j < this.contextVec.length; j++) this.contextVec[j] /= norm;

      this.turn += 1;

      const tensor = new ort.Tensor('float32', this.contextVec, [1, this.contextVec.length]);
      const feeds = { input_embeddings: tensor };
      const results = await this.classifier.run(feeds);

      const outputKey = this.classifier.outputNames[0];
      const prob = results[outputKey].data[0];

      const score = Math.floor(prob * 100);
      let level = 'safe';
      if (score >= 95) level = 'danger';
      else if (score >= 80) level = 'warning';

      return { score, level, depth: this.turn };

    } catch (e) {
      console.error("ì¶”ë¡  ì—ëŸ¬:", e);
      addLog("âš ï¸ ì¶”ë¡  ì‹¤íŒ¨: " + e.message, "danger");
      return null;
    }
  }
}


        // ==========================================
        // 3. ì‹¤í–‰ ë¡œì§ (ê¸°ì¡´ê³¼ ë™ì¼)
        // ==========================================
        const localModel = new RealLocalModel();

        window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (window.SpeechRecognition) {
            recognition = new window.SpeechRecognition();
            recognition.lang = 'ko-KR';
            recognition.continuous = true;
            recognition.interimResults = false;

            recognition.addEventListener('result', async (e) => {
                const text = e.results[e.results.length - 1][0].transcript;
                addTranscript(text);
                await analyzeTextLocally(text);
            });
            recognition.addEventListener('end', () => { if(isRecording) recognition.start(); });
        }

        async function analyzeTextLocally(text) {
            const displayLog = text.length > 15 ? text.substring(0, 15) + "..." : text;
            addLog(`ğŸ¤ ì¸ì‹: "${displayLog}"`, 'send');

            if (!localModel.isReady) {
                addLog("âš ï¸ ëª¨ë¸ ë¡œë”© ì¤‘...", "warning");
                return;
            }

            statusBar.classList.add('analyzing');
            const result = await localModel.predict(text);

            if (result) {
                currentRiskScore = result.score;
                updateGaugeUI(currentRiskScore);
                if (result.level === 'danger') addLog(`ğŸš¨ ìœ„í—˜ ê°ì§€! (${result.score}%)`, 'danger');
                else if (result.level === 'warning') addLog(`âš ï¸ ì˜ì‹¬ íŒ¨í„´ (${result.score}%)`, 'warning');
                else addLog(`âœ… ì •ìƒ (${result.score}%)`, 'safe');

                if (currentSession) {
                    currentSession.finalRisk = currentRiskScore;
                    if (result.level === 'danger') currentSession.isDanger = true;
                }
                if (isRecording) statusText.innerText = `ê°ì‹œ ì¤‘ (ëˆ„ì  ${result.depth}í„´)`;
            }
            statusBar.classList.remove('analyzing');
        }

        // UI Helpers
        function startApp() { document.getElementById('landing-page').style.display = 'none'; document.getElementById('app-container').style.display = 'flex'; }
        function goBack() { if (isRecording) toggleCall(); document.getElementById('app-container').style.display = 'none'; document.getElementById('landing-page').style.display = 'flex'; }

        function updateGaugeUI(score) {
            score = Math.max(0, Math.min(100, score));
            riskPercent.innerText = `${score}%`;
            const offset = CIRCUMFERENCE - (score / 100) * CIRCUMFERENCE;
            gaugeProgress.style.strokeDashoffset = offset;
            if (score < 60) { riskLabel.innerText = "ì•ˆì „"; riskLabel.style.color = "#2ecc71"; gaugeProgress.style.stroke = "#2ecc71"; riskPercent.style.color = "#2ecc71"; gaugeWrapper.classList.remove('danger-active'); }
            else if (score < 90) { riskLabel.innerText = "ì£¼ì˜"; riskLabel.style.color = "#f1c40f"; gaugeProgress.style.stroke = "#f1c40f"; riskPercent.style.color = "#f1c40f"; gaugeWrapper.classList.remove('danger-active'); }
            else { riskLabel.innerText = "ìœ„í—˜"; riskLabel.style.color = "#e74c3c"; gaugeProgress.style.stroke = "#e74c3c"; riskPercent.style.color = "#e74c3c"; gaugeWrapper.classList.add('danger-active'); }
        }

        async function toggleCall() {
            if (!recognition) return;
            if (!isRecording) {
                if (!localModel.isReady) { alert("ëª¨ë¸ ë¡œë”© ì¤‘..."); return; }
                transcriptBox.innerHTML = ''; analysisLog.innerHTML = '';
                addLog("ğŸ”µ í†µí™” ì—°ê²°ë¨", "safe");
                localModel.resetContext(); currentRiskScore = 0; updateGaugeUI(0);
                currentSession = { id: Date.now(), startTime: new Date().toLocaleString(), duration: 0, logs: [], transcripts: [], isDanger: false, finalRisk: 0 };
                recognition.start(); isRecording = true; mainBtn.className = 'recording-mode';
                statusText.innerText = "AI ê°ì‹œ ì¤‘"; statusText.style.color = "#64b5f6";
                startWaveAnimation(); startTimer();
            } else {
                recognition.stop(); isRecording = false; mainBtn.className = 'start-mode';
                addLog("â¹ï¸ í†µí™” ì¢…ë£Œ", "normal");
                if (currentSession) { currentSession.duration = seconds; currentSession.finalRisk = currentRiskScore; historyData.push(currentSession); renderHistoryList(); }
                stopWaveAnimation(); stopTimer();
            }
        }

        function startTimer() { seconds = 0; timerDisplay.innerText = "00:00"; timerInterval = setInterval(() => { seconds++; timerDisplay.innerText = formatTime(seconds); }, 1000); }
        function stopTimer() { clearInterval(timerInterval); timerDisplay.innerText = "HD Voice 00:00"; }
        function formatTime(sec) { const m = Math.floor(sec / 60); const s = sec % 60; return `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`; }
        function startWaveAnimation() { waves.forEach(w => w.style.display = "block"); }
        function stopWaveAnimation() { waves.forEach(w => w.style.display = "none"); }
        function addTranscript(text) { const div = document.createElement('div'); div.className = 'transcript-bubble'; div.innerText = text; transcriptBox.appendChild(div); transcriptBox.scrollTop = transcriptBox.scrollHeight; }
        function addLog(text, type) { if(!analysisLog) return; const div = document.createElement('div'); let className = 'log-item'; if(type === 'danger') className += ' log-danger'; if(type === 'warning') className += ' log-warning'; if(type === 'safe') className += ' log-safe'; if(type === 'send') className += ' log-send'; div.className = className; div.innerText = `[${new Date().toLocaleTimeString()}] ${text}`; analysisLog.appendChild(div); analysisLog.scrollTop = analysisLog.scrollHeight; }
        function toggleSidebar() { sidebar.classList.toggle('open'); overlay.classList.toggle('show'); }
        function renderHistoryList() { historyList.innerHTML = ''; [...historyData].reverse().forEach(session => { const li = document.createElement('li'); li.className = `history-item ${session.finalRisk >= 95 ? 'danger' : (session.finalRisk >= 80 ? 'warning' : 'safe')}`; li.innerHTML = `<span class="h-time">${session.startTime}</span><span class="h-preview">ìµœì¢…: ${session.finalRisk}%</span>`; historyList.appendChild(li); }); }

        window.startApp = startApp; window.goBack = goBack; window.toggleCall = toggleCall; window.toggleSidebar = toggleSidebar;
    </script>
</body>
</html>